<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.whut.cs.bi.biz.mapper.ReportMapper">

    <resultMap type="edu.whut.cs.bi.biz.domain.Report" id="ReportResult">
        <id     property="id"                column="id"                 />
        <result property="name"              column="name"               />
        <result property="status"            column="status"             />
        <result property="reviewerId"        column="reviewer_id"        />
        <result property="approverId"        column="approver_id"        />
        <result property="reportTemplateId"  column="report_template_id" />
        <result property="projectId"         column="project_id"         />
        <result property="minioId"           column="minio_id"           />
        <result property="taskIds"           column="task_ids"           />
        <result property="createBy"          column="create_by"          />
        <result property="createTime"        column="create_time"        />
        <result property="updateBy"          column="update_by"          />
        <result property="updateTime"        column="update_time"        />
        <result property="remark"            column="remark"             />
        <result property="flag"              column="flag"               />
        <result property="reviewer"          column="reviewer"           />
        <result property="approver"          column="approver"           />
    </resultMap>

    <sql id="selectReportVo">
        select r.id, r.name, r.status, r.reviewer_id, r.approver_id, r.report_template_id, r.project_id, r.task_ids,
               r.create_by, r.create_time, r.update_by, r.update_time, r.remark, r.flag,r.minio_id,
               u1.login_name as reviewer, u2.login_name as approver
        from bi_report r
                 left join sys_user u1 on r.reviewer_id = u1.user_id
                 left join sys_user u2 on r.approver_id = u2.user_id
    </sql>

    <select id="selectReportList" parameterType="edu.whut.cs.bi.biz.domain.Report" resultMap="ReportResult">
        <include refid="selectReportVo"/>
        <where>
            r.flag = 0
            <!-- 普通用户权限控制：只能看到自己创建、审核、批准的报告，或者有权限的项目的报告 -->
            <if test="currentUserId != null">
                AND (
                    r.create_by = #{currentUserId}
                    OR r.reviewer_id = #{currentUserId}
                    OR r.approver_id = #{currentUserId}
                    OR EXISTS (
                        SELECT 1 FROM bi_project p
                        INNER JOIN bi_project_user pu ON p.id = pu.project_id
                        WHERE p.id = r.project_id
                        AND pu.user_id = #{currentUserId}
                        AND p.del_flag = '0'
                    )
                )
            </if>
            <!-- 部门管理员权限控制：通过项目的部门ID过滤 -->
            <if test="selectDeptId != null">
                AND EXISTS (
                    SELECT 1 FROM bi_project p
                    WHERE p.id = r.project_id
                    AND (
                        p.dept_id = #{selectDeptId}
                        OR p.owner_dept_id = #{selectDeptId}
                        <if test="parentDeptId != null">
                            OR p.dept_id = #{parentDeptId}
                            OR p.owner_dept_id = #{parentDeptId}
                        </if>
                    )
                    AND p.del_flag = '0'
                )
            </if>
            <if test="report.name != null and report.name != ''">
                AND r.name like concat('%', #{report.name}, '%')
            </if>
            <if test="report.status != null">
                AND r.status = #{report.status}
            </if>
            <if test="report.reviewerId != null">
                AND r.reviewer_id = #{report.reviewerId}
            </if>
            <if test="report.approverId != null">
                AND r.approver_id = #{report.approverId}
            </if>
            <if test="report.reportTemplateId != null">
                AND r.report_template_id = #{report.reportTemplateId}
            </if>
            <if test="report.projectId != null">
                AND r.project_id = #{report.projectId}
            </if>
            <if test="report.taskIds != null and report.taskIds != ''">
                AND r.task_ids = #{report.taskIds}
            </if>
        </where>
    </select>

    <select id="selectReportById" parameterType="Long" resultMap="ReportResult">
        <include refid="selectReportVo"/>
        where r.id = #{id} and r.flag = 0
    </select>

    <insert id="insertReport" parameterType="edu.whut.cs.bi.biz.domain.Report" useGeneratedKeys="true" keyProperty="id">
        insert into bi_report (
            name,
            status,
            reviewer_id,
            approver_id,
            report_template_id,
            project_id,
            minio_id,
            task_ids,
            create_by,
            create_time,
            remark,
            flag
        ) values (
                     #{name},
                     #{status},
                     #{reviewerId},
                     #{approverId},
                     #{reportTemplateId},
                     #{projectId},
                     #{minioId},
                     #{taskIds},
                     #{createBy},
                     sysdate(),
                     #{remark},
                     0
                 )
    </insert>

    <update id="updateReport" parameterType="edu.whut.cs.bi.biz.domain.Report">
        update bi_report
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="status != null">status = #{status},</if>
            <if test="reviewerId != null">reviewer_id = #{reviewerId},</if>
            <if test="approverId != null">approver_id = #{approverId},</if>
            <if test="reportTemplateId != null">report_template_id = #{reportTemplateId},</if>
            <if test="projectId != null">project_id = #{projectId},</if>
            <if test="minioId != null">minio_id = #{minioId},</if>
            <if test="taskIds != null">task_ids = #{taskIds},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate(),
            <if test="remark != null">remark = #{remark},</if>
        </set>
        where id = #{id} and flag = 0
    </update>

    <update id="deleteReportById" parameterType="Long">
        update bi_report set flag = 1 where id = #{id} and flag = 0
    </update>

    <update id="deleteReportByIds" parameterType="String">
        update bi_report set flag = 1
        where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
        and flag = 0
    </update>

</mapper> 