<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('导入历史病害')" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-disease-import" enctype="multipart/form-data">
        <input type="hidden" id="biObjectId" name="biObjectId" th:value="${biObjectId}">
        <input type="hidden" id="taskId" name="taskId" th:value="${taskId}">
        
        <div class="form-group">
            <label class="col-sm-3 control-label">选择文件：</label>
            <div class="col-sm-8">
                <input id="file" name="file" type="file" accept=".xlsx,.xls" class="form-control" required>
                <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> 请选择Excel文件（.xlsx或.xls格式）</span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="col-sm-3 control-label">文件说明：</label>
            <div class="col-sm-8">
                <div class="alert alert-info">
                    <h5><i class="fa fa-info-circle"></i> 文件格式要求：</h5>
                    <ul>
                        <li>文件格式：Excel文件（.xlsx或.xls）</li>
                        <li>包含病害相关信息的标准格式</li>
                        <li>确保数据完整性和准确性</li>
                    </ul>
                </div>
            </div>
        </div>
        
<!--        <div class="form-group">-->
<!--            <div class="col-sm-offset-3 col-sm-8">-->
<!--                <button type="button" class="btn btn-primary" onclick="submitHandler()">开始导入</button>-->
<!--                <button type="button" class="btn btn-default" onclick="$.modal.close()">取消</button>-->
<!--            </div>-->
<!--        </div>-->
    </form>
</div>

<th:block th:include="include :: footer" />

<script th:inline="javascript">
    var prefix = ctx + "biz/disease";
    
    // 添加自定义验证方法
    $.validator.addMethod("fileExtension", function(value, element) {
        var extension = value.split('.').pop().toLowerCase();
        return this.optional(element) || extension === 'xlsx' || extension === 'xls';
    }, "请选择Excel文件(.xlsx或.xls格式)");

    $(function() {
        $("#form-disease-import").validate({
            rules: {
                file: {
                    required: true,
                    fileExtension: true
                }
            },
            errorPlacement: function(error, element) {
                error.insertAfter(element.parent());
            }
        });
    });
    
    function submitHandler() {
        if ($("#form-disease-import").valid()) {
            var fileInput = $('#file')[0];
            if (fileInput.files.length > 0) {
                var formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('taskId', $("#taskId").val());
                formData.append('biObjectId', $("#biObjectId").val());
                
                $.operate.submitJsonFile(prefix + "/upload/CBMSExcel", formData, function(result) {
                    if (result && result.code) {
                        $.modal.alertWarning("系统错误，导入失败！");
                    } else {
                        $.modal.alertSuccess("导入成功");
                        $.modal.close();
                        localStorage.setItem("refreshDiseaseTable", Date.now());
                    }
                });
            }
        }
    }
</script>
</body>
</html>