<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('报告数据填充')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <style>
        .nav-tabs-custom {
            margin-bottom: 20px;
            background: #fff;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        .nav-tabs-custom > .nav-tabs {
            margin: 0;
            border-bottom-color: #f4f4f4;
        }
        .nav-tabs-custom > .nav-tabs > li {
            margin-right: 5px;
        }
        .nav-tabs-custom > .nav-tabs > li > a {
            color: #444;
            border-radius: 0;
        }
        .nav-tabs-custom > .nav-tabs > li.active > a {
            border-left-color: #f4f4f4;
            border-right-color: #f4f4f4;
        }
        .section-title {
            color: #1890ff;
            cursor: pointer;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .section-content {
            margin-left: 20px;
            margin-bottom: 20px;
            padding: 10px;
            border-left: 3px solid #f0f0f0;
        }
        .field-label {
            color: #d9534f;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .image-upload-item {
            margin-bottom: 10px;
        }
        .image-preview {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
        }
        .image-item {
            position: relative;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            padding: 2px;
        }
        .image-item img {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #ddd;
            padding: 3px;
        }
        .collapsible-section {
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 15px;
        }
        .collapsible-section:last-child {
            border-bottom: none;
        }
        .collapsible-section .section-title i {
            margin-right: 5px;
            transition: transform 0.3s;
        }
        .collapsible-section .section-title[aria-expanded="true"] i {
            transform: rotate(0deg);
        }
        .collapsible-section .section-title[aria-expanded="false"] i {
            transform: rotate(-90deg);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .nav-tabs-custom .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ddd;
        }
        .nav-tabs-custom .nav-tabs > li {
            margin-bottom: -1px;
        }
        .nav-tabs-custom .nav-tabs > li > a {
            margin-right: 2px;
            line-height: 1.42857143;
            border: 1px solid transparent;
            border-radius: 4px 4px 0 0;
            padding: 10px 15px;
        }
        .nav-tabs-custom .nav-tabs > li.active > a {
            color: #555;
            background-color: #fff;
            border: 1px solid #ddd;
            border-bottom-color: transparent;
        }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>报告数据填充 - <span th:text="${report.name}"></span></h5>
                </div>
                <div class="ibox-content">
                    <form class="form-horizontal m" id="form-report-data">
                        <input type="hidden" name="reportId" th:value="${report.id}">

                        <!-- 选项卡导航 -->
                        <div class="nav-tabs-custom">
                            <ul class="nav nav-tabs" id="reportTabs">
                                <li class="active"><a href="#tab_0" data-toggle="tab">基本信息</a></li>
                                <li><a href="#tab_1" data-toggle="tab">项目概括</a></li>
                                <li><a href="#tab_2" data-toggle="tab">构件编号</a></li>
                                <li><a href="#tab_3" data-toggle="tab">外观检测结果</a></li>
                                <li><a href="#tab_4" data-toggle="tab">空间变位检测结果</a></li>
                                <li><a href="#tab_5" data-toggle="tab">索力检测结果</a></li>
                                <li><a href="#tab_6" data-toggle="tab">碳化深度及锈蚀电位状况</a></li>
                                <li><a href="#tab_7" data-toggle="tab">重点关注病害及主要病害成因分析</a></li>
                                <li><a href="#tab_8" data-toggle="tab">评定结果</a></li>
                                <li><a href="#tab_9" data-toggle="tab">近两次评定结果对比分析</a></li>
                                <li><a href="#tab_10" data-toggle="tab">结论与建议</a></li>
                            </ul>
                        </div>

                        <!-- 选项卡内容 -->
                        <div class="tab-content">
                            <!-- 基本信息 -->
                            <div class="tab-pane active" id="tab_0">
                                <div class="panel-group" id="accordion_basic">
                                    <!-- 基本信息面板 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_basic" href="#collapse_basic">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 基本信息
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_basic" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <!-- 项目标段 -->
                                                <div class="form-group">
                                                    <label class="control-label">项目标段:</label>
                                                    <input type="text" class="form-control" name="dataValues[${cover-lots}]" data-original-key="${cover-lots}">
                                                </div>

                                                <!-- 报告标题 -->
                                                <div class="form-group">
                                                    <label class="control-label">报告标题:</label>
                                                    <input type="text" class="form-control" name="dataValues[${cover-bridge}]" data-original-key="${cover-bridge}">
                                                </div>

                                                <!-- 封面图片 -->
                                                <div class="form-group image-upload-item">
                                                    <label class="control-label">封面图片:</label>
                                                    <input type="file" name="files" class="file-loading" accept="image/*" data-key="${cover-image}" multiple>
                                                    <input type="hidden" name="dataKeys" value="${cover-image}">
                                                    <input type="hidden" name="dataTypes" value="1">
                                                    <input type="hidden" name="dataValues" class="image-value-holder" id="value-cover-image" data-original-key="${cover-image}">
                                                    <div class="image-preview" id="preview-cover-image" data-original-key="${cover-image}"></div>
                                                </div>

                                                <!-- 委托单位 -->
                                                <div class="form-group">
                                                    <label class="control-label">委托单位:</label>
                                                    <input type="text" class="form-control" name="dataValues[${client-unit}]" data-original-key="${client-unit}">
                                                </div>

                                                <!-- 工程名称 -->
                                                <div class="form-group">
                                                    <label class="control-label">工程名称:</label>
                                                    <input type="text" class="form-control" name="dataValues[${engineering-name}]" data-original-key="${engineering-name}">
                                                </div>

                                                <!-- 检测类别 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测类别:</label>
                                                    <input type="text" class="form-control" name="dataValues[${detection-category}]" data-original-key="${detection-category}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_0')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 项目概括 -->
                            <div class="tab-pane" id="tab_1">
                                <div class="panel-group" id="accordion">
                                    <!-- 工程概况 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 工程概况
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse1" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">工程概况:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-1-overviewOfProject}]" data-original-key="${chapter-1-1-overviewOfProject}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 桥梁概况 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse2">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 桥梁概况
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse2" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">桥梁概况:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-2-overviewOfBridge}]" data-original-key="${chapter-1-2-overviewOfBridge}" rows="5"></textarea>
                                                </div>

                                                <!-- 桥型布置图 -->
                                                <div class="form-group image-upload-item">
                                                    <label class="control-label">桥型布置图:</label>
                                                    <input type="file" name="files" class="file-loading" accept="image/*" data-key="${chapter-1-2-bridgeLayoutPlan}" multiple>
                                                    <input type="hidden" name="dataKeys" value="${chapter-1-2-bridgeLayoutPlan}">
                                                    <input type="hidden" name="dataTypes" value="1">
                                                    <input type="hidden" name="dataValues" class="image-value-holder" id="value-chapter-1-2-bridgeLayoutPlan" data-original-key="${chapter-1-2-bridgeLayoutPlan}">
                                                    <div class="image-preview" id="preview-chapter-1-2-bridgeLayoutPlan" data-original-key="${chapter-1-2-bridgeLayoutPlan}"></div>
                                                </div>

                                                <!-- 横断面布置图 -->
                                                <div class="form-group image-upload-item">
                                                    <label class="control-label">横断面布置图:</label>
                                                    <input type="file" name="files" class="file-loading" accept="image/*" data-key="${chapter-1-2-bridgeStandardCrossSection}" multiple>
                                                    <input type="hidden" name="dataKeys" value="${chapter-1-2-bridgeStandardCrossSection}">
                                                    <input type="hidden" name="dataTypes" value="1">
                                                    <input type="hidden" name="dataValues" class="image-value-holder" id="value-chapter-1-2-bridgeStandardCrossSection" data-original-key="${chapter-1-2-bridgeStandardCrossSection}">
                                                    <div class="image-preview" id="preview-chapter-1-2-bridgeStandardCrossSection" data-original-key="${chapter-1-2-bridgeStandardCrossSection}"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 技术要点 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse3">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 技术要点
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse3" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">技术要点:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-3-KeyDesignPoints}]" data-original-key="${chapter-1-3-KeyDesignPoints}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 技术标准 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse4">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 技术标准
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse4" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">技术标准:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-4-standard}]" data-original-key="${chapter-1-4-standard}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 历史检测情况 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse5">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 历史检测情况
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse5" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">历史检测情况:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-5-historicalInspectionStatus}]" data-original-key="${chapter-1-5-historicalInspectionStatus}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 历史维修情况 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion" href="#collapse6">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 历史维修情况
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse6" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">历史维修情况:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-1-6-historicalMaintenanceStatus}]" data-original-key="${chapter-1-6-historicalMaintenanceStatus}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_1')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 构件编号 -->
                            <div class="tab-pane" id="tab_2">
                                <div class="panel-group" id="accordion_component">
                                    <!-- 构件编号面板 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_component" href="#collapse_component">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 构件编号
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_component" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <!-- 构件编号 -->
                                                <div class="form-group">
                                                    <label class="control-label">构件编号:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-2-componentCode}]" data-original-key="${chapter-2-componentCode}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_2')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 外观检测结果 -->
                            <div class="tab-pane" id="tab_3">
                                <div class="alert alert-info">
                                    外观检测结果选项卡的内容将根据需求添加
                                </div>
                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_3')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 空间变位检测结果 -->
                            <div class="tab-pane" id="tab_4">
                                <div class="panel-group" id="accordion_spatial">
                                    <!-- 桥面高程 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_spatial" href="#collapse_bridge_elevation">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 桥面高程
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_bridge_elevation" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <!-- 检测内容及方法 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测内容及方法:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-1-testContentsAndMethods}]" data-original-key="${chapter-4-1-testContentsAndMethods}" rows="5"></textarea>
                                                </div>

                                                <!-- 桥梁测点布置示意图 -->
                                                <div class="form-group image-upload-item">
                                                    <label class="control-label">桥梁测点布置示意图:</label>
                                                    <input type="file" name="files" class="file-loading" accept="image/*" data-key="${chapter-4-1-layoutOfMeasuringPoints}" data-image-title="测点布置示意图" multiple>
                                                    <input type="hidden" name="dataKeys" value="${chapter-4-1-layoutOfMeasuringPoints}">
                                                    <input type="hidden" name="dataTypes" value="1">
                                                    <input type="hidden" name="dataValues" class="image-value-holder" id="value-chapter-4-1-layoutOfMeasuringPoints" data-original-key="${chapter-4-1-layoutOfMeasuringPoints}">
                                                    <div class="image-preview" id="preview-chapter-4-1-layoutOfMeasuringPoints" data-original-key="${chapter-4-1-layoutOfMeasuringPoints}"></div>
                                                </div>

                                                <!-- 检测结果 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测结果:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-1-detectionResult}]" data-original-key="${chapter-4-1-detectionResult}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 墩台变位 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_spatial" href="#collapse_pier_displacement">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 墩台变位
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_pier_displacement" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <!-- 墩台变位 -->
                                                <div class="form-group">
                                                    <label class="control-label">墩台变位:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-1-pier}]" data-original-key="${chapter-4-1-pier}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 墩台倾斜度 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_spatial" href="#collapse_pier_tilt">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 墩台倾斜度
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_pier_tilt" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <!-- 检测结论 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测结论:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-3-result}]" data-original-key="${chapter-4-3-result}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 索塔变位 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_spatial" href="#collapse_tower_displacement">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 索塔变位
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_tower_displacement" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <!-- 检测内容及方法 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测内容及方法:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-4-testContentsAndMethods}]" data-original-key="${chapter-4-4-testContentsAndMethods}" rows="5"></textarea>
                                                </div>

                                                <!-- 检测数据 -->
                                                <div class="form-group">
                                                    <label class="control-label">检测数据:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-4-4-detectionData}]" data-original-key="${chapter-4-4-detectionData}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_4')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_5">
                                <div class="alert alert-info">
                                    索力检测结果选项卡的内容将根据需求添加
                                </div>
                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_5')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_6">
                                <div class="alert alert-info">
                                    碳化深度及锈蚀电位状况选项卡的内容将根据需求添加
                                </div>
                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_6')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_7">
                                <div class="panel-group" id="accordion_disease_analysis">
                                    <!-- 重点关注病害 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_disease_analysis" href="#collapse_focus_diseases">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 重点关注病害
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_focus_diseases" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">重点关注病害:</label>
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <input type="text" class="form-control" readonly
                                                                   id="focus-diseases-display"
                                                                   placeholder="请选择重点关注病害"
                                                                   onclick="showDiseaseSelector('focus-diseases')">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-primary" onclick="showDiseaseSelector('focus-diseases')">
                                                                <i class="fa fa-list"></i> 选择
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- 隐藏字段存储JSON数据 -->
                                                    <input type="hidden" name="dataValues[${chapter-7-1-focusOnDiseases}]"
                                                           data-original-key="${chapter-7-1-focusOnDiseases}"
                                                           id="focus-diseases-value">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 主要病害成因分析 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_disease_analysis" href="#collapse_cause_analysis">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-right"></i> 主要病害成因分析
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_cause_analysis" class="panel-collapse collapse">
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="control-label">主要病害成因分析:</label>
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <input type="text" class="form-control" readonly
                                                                   id="cause-analysis-display"
                                                                   placeholder="请选择主要病害成因分析"
                                                                   onclick="showDiseaseSelector('cause-analysis')">
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-primary" onclick="showDiseaseSelector('cause-analysis')">
                                                                <i class="fa fa-list"></i> 选择
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- 隐藏字段存储JSON数据 -->
                                                    <input type="hidden" name="dataValues[${chapter-7-2-analysisOfTheCausesOfMajorDiseases}]"
                                                           data-original-key="${chapter-7-2-analysisOfTheCausesOfMajorDiseases}"
                                                           id="cause-analysis-value">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_7')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_8">
                                <div class="alert alert-info">
                                    评定结果选项卡的内容将根据需求添加
                                </div>
                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_8')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_9">
                                <div class="alert alert-info">
                                    近两次评定结果对比分析选项卡的内容将根据需求添加
                                </div>
                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_9')">保存</button>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="tab_10">
                                <div class="panel-group" id="accordion_conclusion">
                                    <!-- 结论与建议面板 -->
                                    <div class="panel panel-default">
                                        <div class="panel-heading" data-toggle="collapse" data-parent="#accordion_conclusion" href="#collapse_conclusion">
                                            <h4 class="panel-title">
                                                <a class="accordion-toggle">
                                                    <i class="fa fa-chevron-down"></i> 技术建议
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapse_conclusion" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <!-- 技术建议 -->
                                                <div class="form-group">
                                                    <label class="control-label">技术建议:</label>
                                                    <textarea class="form-control" name="dataValues[${chapter-10-technicalAdvice}]" data-original-key="${chapter-10-technicalAdvice}" rows="5"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 保存按钮 -->
                                <div class="form-group">
                                    <div class="col-sm-12 text-center">
                                        <button type="button" class="btn btn-primary" onclick="saveTabData('tab_10')">保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 病害选择器模态框 -->
<div class="modal fade" id="diseaseSelectModal" tabindex="-1" role="dialog" aria-labelledby="diseaseSelectModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="diseaseSelectModalLabel">选择病害</h4>
            </div>
            <div class="modal-body">
                <!-- 任务Tab导航 -->
                <ul class="nav nav-tabs" id="diseaseTaskTabs" role="tablist" style="margin-bottom: 15px;">
                    <!-- 动态生成任务Tab -->
                </ul>
                
                <!-- Tab内容区 -->
                <div class="tab-content" id="diseaseTaskTabContent">
                    <!-- 动态生成每个任务的病害选择内容 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmDiseaseSelection">确定</button>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: bootstrap-fileinput-js"/>
<script th:inline="javascript">
    var prefix = ctx + "biz/report_data";
    var reportId = /*[[${report.id}]]*/ '';
    var currentSelectorType = ''; // 当前选择器类型：focus-diseases 或 cause-analysis
    var diseaseComponentData = {}; // 存储构件病害数据，格式：{taskId: {taskId, buildingName, diseases: []}}

    $(function() {
        // 初始化文件上传控件
        initFileInputs();

        // 加载报告数据
        loadReportData();

        // 监听选项卡切换事件
        $('#reportTabs a').on('show.bs.tab', function (e) {
            // 获取当前激活的选项卡
            var currentTab = $('.nav-tabs li.active a').attr("href");
            var targetTab = $(e.target).attr("href");

            console.log("准备从选项卡 " + currentTab + " 切换到 " + targetTab);

            // 如果当前选项卡存在且不为空，则自动保存当前选项卡数据
            if (currentTab && currentTab !== targetTab) {
                var currentTabId = currentTab.replace('#', '');
                console.log("自动保存当前选项卡数据: " + currentTabId);

                // 同步保存当前选项卡数据
                saveTabDataSync(currentTabId);
            }
        });

        $('#reportTabs a').on('shown.bs.tab', function (e) {
            var targetTab = $(e.target).attr("href");
            console.log("已切换到选项卡: " + targetTab);
        });

        // 监听折叠面板事件
        $('.panel-heading').on('click', function() {
            var $icon = $(this).find('.fa');
            var $panelBody = $($(this).attr('href'));
            var isExpanded = $panelBody.hasClass('in');

            // 更新图标
            if (isExpanded) {
                $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
            } else {
                // 先将所有图标重置
                $('.panel-heading').find('.fa').removeClass('fa-chevron-down').addClass('fa-chevron-right');
                // 设置当前图标
                $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            }
        });

        // 初始化面板图标
        $('.panel-collapse').each(function() {
            var isExpanded = $(this).hasClass('in');
            var $icon = $(this).siblings('.panel-heading').find('.fa');

            if (isExpanded) {
                $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            } else {
                $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
            }
        });
    });

    // 初始化文件上传控件
    function initFileInputs() {
        $('input[type="file"]').each(function() {
            var $this = $(this);
            var key = $this.data('key');

            $this.fileinput({
                'theme': 'fa',
                language: 'zh',
                showUpload: false,
                showCaption: false,
                showRemove: true,
                showPreview: true,
                browseClass: "btn btn-primary",
                fileType: "any",
                previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
                allowedFileExtensions: ['jpg', 'jpeg', 'png', 'gif'],
                uploadExtraData: function() {
                    return {
                        key: key
                    };
                },
                // 自定义文件名，确保文件名包含key
                uploadUrl: '#',
                fileActionSettings: {
                    showUpload: false,
                    showZoom: true,
                    showDrag: false,
                    showDownload: false,
                    removeIcon: '<i class="fa fa-trash"></i>'
                }
            }).on('fileselect', function(event, numFiles, label) {
                // 当选择文件时，修改文件名为key_index格式
                var files = $(this)[0].files;
                if (files && files.length > 0) {
                    for (var i = 0; i < files.length; i++) {
                        // 注意：这里不能直接修改File对象的name属性，但在提交时会处理
                        console.log('Selected file: ' + files[i].name + ' for key: ' + key + '_' + i);
                    }
                }
            });
        });
    }

    // 加载报告数据
    function loadReportData() {
        $.ajax({
            url: prefix + "/list",
            type: "post",
            data: {
                "reportId": reportId
            },
            dataType: "json",
            success: function(result) {
                console.log('加载报告数据结果:', result);
                if (result.rows && result.rows.length > 0) {
                    console.log('开始填充表单数据，记录数:', result.rows.length);

                    // 检查是否有病害选择相关的数据
                    var diseaseData = result.rows.filter(function(item) {
                        return item.key && (item.key.includes('chapter-7-1-focusOnDiseases') || item.key.includes('chapter-7-2-analysisOfTheCausesOfMajorDiseases'));
                    });
                    console.log('病害选择相关数据:', diseaseData);

                    fillFormData(result.rows);
                } else {
                    console.log('没有加载到报告数据');
                }
            },
            error: function() {
                $.modal.alertError("加载数据失败");
            }
        });
    }

    // 填充表单数据
    function fillFormData(dataList) {
        // 遍历数据，填充到对应的表单字段
        for (var i = 0; i < dataList.length; i++) {
            var data = dataList[i];
            var key = data.key;
            var value = data.value;
            var type = data.type;

            if (type == 0) {
                // 文本类型 - 使用data-original-key属性查找元素
                $('textarea[data-original-key="' + key + '"]').val(value);
                $('input[type="text"][data-original-key="' + key + '"]').val(value);
                $('input[type="hidden"][data-original-key="' + key + '"]').val(value);
            } else if (type == 1) {
                // 图片类型 - 使用属性选择器查找元素
                if (value) {
                    // 使用data-original-key属性查找元素
                    var $valueHolder = $('.image-value-holder[data-original-key="' + key + '"]');
                    var $previewContainer = $('.image-preview[data-original-key="' + key + '"]');

                    if ($valueHolder.length > 0) {
                        // 设置隐藏字段的值，用于保存已有图片的URL
                        $valueHolder.val(value);

                        // 显示已上传的图片预览
                        var imgHtml = '';

                        // 处理可能的多图片（逗号分隔的URL）
                        var imageUrls = value.split(',');
                        var validUrls = [];

                        // 先筛选有效URL
                        for (var j = 0; j < imageUrls.length; j++) {
                            var url = imageUrls[j].trim();
                            if (url) {
                                validUrls.push(url);
                            }
                        }

                        // 如果没有有效URL，直接清空预览区域
                        if (validUrls.length === 0) {
                            $previewContainer.empty();
                            return;
                        }

                        // 清空预览区域，添加加载指示器
                        $previewContainer.html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> 正在加载图片...</div>');

                        // 创建一个计数器和结果数组
                        var loadCounter = {
                            total: validUrls.length,
                            loaded: 0,
                            results: [],
                            originalIds: [] // 存储原始ID
                        };

                        // 处理每个URL
                        for (var j = 0; j < validUrls.length; j++) {
                            processImageUrl(validUrls[j], j, loadCounter, $previewContainer);
                        }
                    }
                }
            }
        }
    }

    // 处理单个图片URL
    function processImageUrl(url, index, counter, container) {
        // 存储原始ID
        counter.originalIds[index] = url;

        // 如果是纯数字ID，通过后端获取实际URL
        if (/^\d+$/.test(url)) {
            $.ajax({
                url: prefix + "/getFileUrl",
                type: "post",
                data: {
                    "fileId": url
                },
                dataType: "json",
                success: function(result) {
                    if (result.code == 0) {
                        counter.results[index] = result.data;
                    } else {
                        console.error("获取文件URL失败：" + result.msg);
                        counter.results[index] = "#"; // 使用占位符
                    }
                    updateImagePreview(counter, container);
                },
                error: function() {
                    console.error("获取文件URL失败");
                    counter.results[index] = "#"; // 使用占位符
                    updateImagePreview(counter, container);
                }
            });
        } else {
            // 直接使用URL
            counter.results[index] = url;
            updateImagePreview(counter, container);
        }
    }

    // 更新图片预览
    function updateImagePreview(counter, container) {
        counter.loaded++;
        console.log("已加载: " + counter.loaded + "/" + counter.total);

        // 当所有图片URL都处理完毕时，更新预览区域
        if (counter.loaded >= counter.total) {
            var imgHtml = '';
            for (var i = 0; i < counter.results.length; i++) {
                if (counter.results[i]) {
                    // 获取原始ID
                    var originalId = counter.originalIds[i];

                    imgHtml += '<div class="image-item" data-id="' + originalId + '">';
                    imgHtml += '<div class="image-actions">';
                    imgHtml += '<a href="javascript:void(0);" class="btn btn-xs btn-danger remove-image" title="删除"><i class="fa fa-trash"></i></a>';
                    imgHtml += '</div>';
                    imgHtml += '<a href="' + counter.results[i] + '" target="_blank"><img src="' + counter.results[i] + '" alt="预览图"></a>';
                    imgHtml += '</div>';
                }
            }

            if (imgHtml) {
                container.html(imgHtml);

                // 绑定删除按钮事件
                container.find('.remove-image').on('click', function() {
                    var imageItem = $(this).closest('.image-item');
                    var imageId = imageItem.data('id');

                    // 获取 data-original-key 属性值
                    var originalKey = container.data('original-key');
                    console.log("删除图片，ID:", imageId, "原始Key:", originalKey);

                    // 使用 data-original-key 属性查找隐藏字段
                    var $valueHolder = $('.image-value-holder[data-original-key="' + originalKey + '"]');
                    var currentValue = $valueHolder.val();

                    console.log("找到隐藏字段:", $valueHolder.length > 0, "当前值:", currentValue);

                    if (currentValue) {
                        // 拆分并清理 ID 列表
                        var ids = currentValue.split(',').map(function(id) {
                            return id.trim();
                        }).filter(Boolean); // 去掉空字符串

                        // 过滤掉要删除的 ID
                        var newIds = ids.filter(function(id) {
                            return Number(id) !== Number(imageId);
                        });

                        // 更新隐藏字段
                        var newValue = newIds.join(',');
                        $valueHolder.val(newValue);
                        console.log("更新后的值:", newValue);
                    }


                    // 移除图片项
                    imageItem.remove();

                    // 如果没有图片了，显示提示
                    if (container.find('.image-item').length === 0) {
                        container.html('<div class="text-center">无图片</div>');
                    }
                });
            } else {
                container.html('<div class="text-center">无图片</div>');
            }
        }
    }

    // 保存选项卡数据
    function saveTabData(tabId) {
        saveTabDataInternal(tabId, true); // 异步保存，显示加载提示
    }

    // 同步保存选项卡数据（用于切换选项卡时的自动保存）
    function saveTabDataSync(tabId) {
        saveTabDataInternal(tabId, false); // 同步保存，不显示加载提示
    }

    // 内部保存方法
    function saveTabDataInternal(tabId, showLoading) {
        // 创建FormData对象
        var formData = new FormData();
        formData.append("reportId", reportId);

        // 获取当前选项卡下的所有表单字段
        var tabPane = $('#' + tabId);

        // 添加文本字段 - textarea
        tabPane.find('textarea').each(function() {
            var key = $(this).data('original-key');
            var value = $(this).val();

            // 添加到FormData
            formData.append("dataKeys", key);
            formData.append("dataValues", value);
            formData.append("dataTypes", "0"); // 0表示文本类型
        });

        // 添加文本字段 - input[type="text"]
        tabPane.find('input[type="text"]').each(function() {
            var key = $(this).data('original-key');
            var value = $(this).val();

            // 只处理有original-key属性的文本字段，排除病害选择的显示字段
            if (key) {
                // 添加到FormData
                formData.append("dataKeys", key);
                formData.append("dataValues", value);
                formData.append("dataTypes", "0"); // 0表示文本类型
            }
        });

        // 添加病害选择字段 - 处理隐藏字段中的JSON数据
        tabPane.find('input[type="hidden"][data-original-key]').each(function() {
            var key = $(this).data('original-key');
            var value = $(this).val();

            // 检查是否是病害选择相关的字段
            if (key && (key.includes('chapter-7-1-focusOnDiseases') || key.includes('chapter-7-2-analysisOfTheCausesOfMajorDiseases'))) {
                console.log('处理病害选择字段:', key, '值:', value);

                // 添加到FormData
                formData.append("dataKeys", key);
                formData.append("dataValues", value || ""); // 如果没有值，传空字符串
                formData.append("dataTypes", "0"); // 0表示文本类型（JSON字符串作为文本存储）
            }
        });

        // 添加图片字段
        tabPane.find('.image-preview').each(function() {
            var originalKey = $(this).data('original-key');
            if (originalKey) {
                // 使用data-original-key属性查找隐藏字段
                var $valueHolder = $('.image-value-holder[data-original-key="' + originalKey + '"]');

                // 添加键和类型
                formData.append("dataKeys", originalKey);
                formData.append("dataTypes", "1"); // 1表示图片类型

                // 如果有值，添加到dataValues
                if ($valueHolder.length > 0) {
                    var value = $valueHolder.val() || '';
                    formData.append("dataValues", value);
                    console.log("保存图片字段:", originalKey, "值:", value);
                } else {
                    formData.append("dataValues", "");
                    console.log("未找到隐藏字段:", originalKey);
                }

                // 添加新选择的文件（如果有）
                var fileInput = $(this).closest('.form-group').find('input[type="file"]');
                var files = fileInput[0].files;
                if (files && files.length > 0) {
                    for (var i = 0; i < files.length; i++) {
                        // 创建一个新的文件对象，文件名格式为：${key}_index.ext
                        var originalName = files[i].name;
                        var extension = originalName.substring(originalName.lastIndexOf('.'));
                        var newFileName = originalKey + '_' + i + extension;

                        // 由于不能直接修改File对象的name，我们使用自定义的文件名属性
                        var renamedFile = new File([files[i]], newFileName, { type: files[i].type });
                        formData.append("files", renamedFile);
                        console.log("添加文件:", newFileName);
                    }
                }
            }
        });

        // 打印所有formData内容
        console.log("FormData内容 (tabId: " + tabId + "):");
        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        // 发送AJAX请求
        $.ajax({
            url: prefix + "/save",
            type: "post",
            data: formData,
            processData: false,
            contentType: false,
            async: showLoading, // 根据参数决定是否异步
            beforeSend: function() {
                if (showLoading) {
                    $.modal.loading("正在保存数据，请稍候...");
                }
            },
            success: function(result) {
                if (showLoading) {
                    $.modal.closeLoading();
                }

                if (result.code == 0) {
                    if (showLoading) {
                        $.modal.alertSuccess("保存成功");
                        // 清空文件输入框
                        tabPane.find('input[type="file"]').fileinput('clear');
                    } else {
                        console.log("自动保存成功: " + tabId);
                    }
                    // 重新加载数据
                    loadReportData();
                } else {
                    if (showLoading) {
                        $.modal.alertError(result.msg);
                    } else {
                        console.error("自动保存失败: " + result.msg);
                    }
                }
            },
            error: function() {
                if (showLoading) {
                    $.modal.closeLoading();
                    $.modal.alertError("保存失败");
                } else {
                    console.error("自动保存网络错误: " + tabId);
                }
            }
        });
    }

    // 显示病害选择器
    function showDiseaseSelector(selectorType) {
        currentSelectorType = selectorType;

        // 设置模态框标题
        var title = selectorType === 'focus-diseases' ? '选择重点关注病害' : '选择主要病害成因分析';
        $('#diseaseSelectModalLabel').text(title);

        // 检查数据是否已加载（缓存）
        if (Object.keys(diseaseComponentData).length > 0) {
            // 数据已缓存，直接渲染选择列表
            console.log('使用缓存的病害构件数据');
            renderDiseaseSelectionTabs();
        } else {
            // 第一次点击，需要加载数据
            console.log('第一次打开选择器，开始加载病害构件数据...');
            $('#diseaseTaskTabContent').html('<div class="text-center" style="padding: 50px;"><i class="fa fa-spinner fa-spin"></i> 正在加载数据...</div>');

            // 加载数据并缓存
            loadDiseaseComponentDataWithCallback(function() {
                // 加载成功后渲染列表
                renderDiseaseSelectionTabs();
            });
        }

        // 显示模态框
        $('#diseaseSelectModal').modal('show');
    }

    // 加载构件病害数据（带回调函数）
    function loadDiseaseComponentDataWithCallback(successCallback) {
        // 如果数据已加载，直接执行回调
        if (Object.keys(diseaseComponentData).length > 0) {
            console.log('数据已缓存，直接执行回调');
            if (successCallback) successCallback();
            return;
        }

        console.log('开始加载病害构件数据...');

        $.ajax({
            url: prefix + "/getDiseaseComponentData",
            type: "post",
            data: {
                "reportId": reportId
            },
            dataType: "json",
            success: function(result) {
                if (result.code == 0 && result.data) {
                    diseaseComponentData = result.data;
                    var taskCount = Object.keys(diseaseComponentData).length;
                    console.log('病害构件数据加载成功，共 ' + taskCount + ' 个任务');

                    // 执行成功回调
                    if (successCallback) successCallback();
                } else {
                    console.error('加载病害构件数据失败：' + (result.msg || '未知错误'));
                    $('#diseaseTaskTabContent').html('<div class="text-center text-danger">加载数据失败：' + (result.msg || '未知错误') + '</div>');
                }
            },
            error: function() {
                console.error('加载病害构件数据失败，网络错误');
                $('#diseaseTaskTabContent').html('<div class="text-center text-danger">加载数据失败，请重试</div>');
            }
        });
    }

    // 兼容原有的加载函数（保留用于数据回显等场景）
    function loadDiseaseComponentData() {
        loadDiseaseComponentDataWithCallback();
    }

    // 渲染病害选择Tab页签和内容
    function renderDiseaseSelectionTabs() {
        if (!diseaseComponentData || Object.keys(diseaseComponentData).length === 0) {
            $('#diseaseTaskTabs').html('');
            $('#diseaseTaskTabContent').html('<div class="text-center text-muted" style="padding: 50px;">暂无数据</div>');
            return;
        }

        var tabsHtml = '';
        var contentHtml = '';
        var isFirst = true;

        // 遍历所有任务
        for (var taskId in diseaseComponentData) {
            var taskData = diseaseComponentData[taskId];
            var buildingName = taskData.buildingName || '未命名桥梁';
            var diseases = taskData.diseases || [];

            // 生成Tab标签
            tabsHtml += '<li role="presentation" class="' + (isFirst ? 'active' : '') + '">';
            tabsHtml += '<a href="#task-' + taskId + '" data-toggle="tab">' + buildingName + '</a>';
            tabsHtml += '</li>';

            // 生成Tab内容
            contentHtml += '<div role="tabpanel" class="tab-pane ' + (isFirst ? 'active' : '') + '" id="task-' + taskId + '">';
            contentHtml += renderDiseaseListForTask(taskId, buildingName, diseases);
            contentHtml += '</div>';

            isFirst = false;
        }

        $('#diseaseTaskTabs').html(tabsHtml);
        $('#diseaseTaskTabContent').html(contentHtml);

        // 绑定事件
        bindDiseaseSelectionEvents();
    }

    // 为单个任务渲染病害列表
    function renderDiseaseListForTask(taskId, buildingName, diseases) {
        var html = '';

        // 搜索过滤框
        html += '<div class="row" style="margin-top: 15px;">';
        html += '<div class="col-md-12">';
        html += '<div class="form-group">';
        html += '<label>搜索过滤:</label>';
        html += '<input type="text" class="form-control disease-search-input" data-task-id="' + taskId + '" placeholder="输入构件名称或病害类型进行搜索">';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // 病害列表容器
        html += '<div class="row">';
        html += '<div class="col-md-12">';
        html += '<div class="panel panel-default">';
        html += '<div class="panel-heading">';
        html += '<div class="checkbox">';
        html += '<label>';
        html += '<input type="checkbox" class="select-all-diseases" data-task-id="' + taskId + '"> 全选/全不选';
        html += '</label>';
        html += '</div>';
        html += '</div>';
        html += '<div class="panel-body" style="max-height: 400px; overflow-y: auto;">';
        html += '<div class="disease-selection-list" data-task-id="' + taskId + '">';

        if (diseases && diseases.length > 0) {
            // 获取当前已选择的数据
            var currentValue = $('#' + currentSelectorType + '-value').val();
            var selectedData = {};
            if (currentValue && currentValue.trim() !== '' && currentValue !== '{}') {
                try {
                    selectedData = JSON.parse(currentValue);
                    console.log('解析已选择数据:', selectedData);
                } catch (e) {
                    console.error('解析已选择数据失败:', e);
                }
            }

            // 获取该任务的已选择数据
            var taskSelections = selectedData[taskId] || [];
            
            // 创建已选择数据的映射
            var selectedMap = {};
            for (var i = 0; i < taskSelections.length; i++) {
                var item = taskSelections[i];
                for (var componentId in item) {
                    var diseaseTypeIds = item[componentId];
                    if (!selectedMap[componentId]) {
                        selectedMap[componentId] = {};
                    }
                    for (var j = 0; j < diseaseTypeIds.length; j++) {
                        selectedMap[componentId][diseaseTypeIds[j]] = true;
                    }
                }
            }

            // 按构件分组渲染
            var componentGroups = {};
            for (var i = 0; i < diseases.length; i++) {
                var item = diseases[i];
                var componentId = item.componentId;
                var componentName = item.componentName;

                if (!componentGroups[componentId]) {
                    componentGroups[componentId] = {
                        name: componentName,
                        diseases: []
                    };
                }
                componentGroups[componentId].diseases.push({
                    diseaseTypeId: item.diseaseTypeId,
                    diseaseTypeName: item.diseaseTypeName
                });
            }

            // 渲染HTML
            for (var componentId in componentGroups) {
                var group = componentGroups[componentId];
                html += '<div class="component-group" style="margin-bottom: 20px;">';
                html += '<h5 style="color: #337ab7; border-bottom: 1px solid #ddd; padding-bottom: 5px;">';
                html += '<i class="fa fa-building-o"></i> ' + group.name + '</h5>';

                for (var j = 0; j < group.diseases.length; j++) {
                    var disease = group.diseases[j];
                    var isChecked = selectedMap[componentId] && selectedMap[componentId][disease.diseaseTypeId];

                    html += '<div class="checkbox" style="margin-left: 20px;">';
                    html += '<label>';
                    html += '<input type="checkbox" class="disease-checkbox" ';
                    html += 'data-task-id="' + taskId + '" ';
                    html += 'data-component-id="' + componentId + '" ';
                    html += 'data-component-name="' + group.name + '" ';
                    html += 'data-disease-type-id="' + disease.diseaseTypeId + '" ';
                    html += 'data-disease-type-name="' + disease.diseaseTypeName + '"';
                    if (isChecked) {
                        html += ' checked';
                    }
                    html += '> ' + group.name + ' + ' + disease.diseaseTypeName;
                    html += '</label>';
                    html += '</div>';
                }
                html += '</div>';
            }
        } else {
            html += '<div class="text-center text-muted">该任务暂无病害数据</div>';
        }

        html += '</div>'; // disease-selection-list
        html += '</div>'; // panel-body
        html += '</div>'; // panel
        html += '</div>'; // col-md-12
        html += '</div>'; // row

        return html;
    }

    // 绑定病害选择事件
    function bindDiseaseSelectionEvents() {
        // 全选/全不选事件（为每个任务Tab独立绑定）
        $('.select-all-diseases').off('change').on('change', function() {
            var taskId = $(this).data('task-id');
            var isChecked = $(this).prop('checked');
            $('.disease-checkbox[data-task-id="' + taskId + '"]').prop('checked', isChecked);
        });

        // 搜索过滤事件（为每个任务Tab独立绑定）
        $('.disease-search-input').off('input').on('input', function() {
            var taskId = $(this).data('task-id');
            var searchText = $(this).val().toLowerCase();
            var $listContainer = $('.disease-selection-list[data-task-id="' + taskId + '"]');
            
            $listContainer.find('.component-group').each(function() {
                var $group = $(this);
                var hasMatch = false;

                $group.find('.checkbox').each(function() {
                    var $checkbox = $(this);
                    var text = $checkbox.text().toLowerCase();
                    if (text.indexOf(searchText) !== -1) {
                        $checkbox.show();
                        hasMatch = true;
                    } else {
                        $checkbox.hide();
                    }
                });

                if (hasMatch || searchText === '') {
                    $group.show();
                } else {
                    $group.hide();
                }
            });
        });

        // 确定按钮事件
        $('#confirmDiseaseSelection').off('click').on('click', function() {
            confirmDiseaseSelection();
        });
    }

    // 确认病害选择
    function confirmDiseaseSelection() {
        var allTaskSelections = {}; // 格式：{taskId: [{componentId: [diseaseTypeIds]}]}

        // 遍历所有任务的选择列表
        $('.disease-selection-list').each(function() {
            var taskId = $(this).data('task-id');
            var componentMap = {}; // 用于按构件ID分组

            // 收集该任务的选中项目
            $(this).find('.disease-checkbox:checked').each(function() {
                var componentId = $(this).data('component-id');
                var diseaseTypeId = $(this).data('disease-type-id');

                if (!componentMap[componentId]) {
                    componentMap[componentId] = [];
                }
                componentMap[componentId].push(parseInt(diseaseTypeId));
            });

            // 转换为数组格式
            var taskSelections = [];
            for (var componentId in componentMap) {
                var item = {};
                item[parseInt(componentId)] = componentMap[componentId];
                taskSelections.push(item);
            }

            // 只保存有选择的任务
            if (taskSelections.length > 0) {
                allTaskSelections[taskId] = taskSelections;
            }
        });

        console.log('所有任务的选择数据:', allTaskSelections);

        // 更新隐藏字段
        var jsonValue = JSON.stringify(allTaskSelections);
        console.log('JSON字符串:', jsonValue);

        var $hiddenField = $('#' + currentSelectorType + '-value');
        $hiddenField.val(jsonValue);

        // 更新显示字段
        updateDiseaseDisplay(currentSelectorType);

        // 关闭模态框
        $('#diseaseSelectModal').modal('hide');
    }

    // 更新病害显示
    function updateDiseaseDisplay(selectorType) {
        var value = $('#' + selectorType + '-value').val();
        var displayText = '';

        if (value && value.trim() !== '' && value !== '{}') {
            try {
                var selectedData = JSON.parse(value);
                var totalCount = 0;

                // 计算总选择数量（遍历所有任务）
                for (var taskId in selectedData) {
                    var taskSelections = selectedData[taskId];
                    for (var i = 0; i < taskSelections.length; i++) {
                        var item = taskSelections[i];
                        for (var componentId in item) {
                            var diseaseTypeIds = item[componentId];
                            totalCount += diseaseTypeIds.length;
                        }
                    }
                }

                if (totalCount > 0) {
                    displayText = '已选择' + totalCount + '项';
                } else {
                    displayText = '请选择';
                }
            } catch (e) {
                console.error('解析选择数据失败:', e);
                displayText = '数据格式错误';
            }
        } else {
            displayText = '请选择';
        }

        $('#' + selectorType + '-display').val(displayText);
    }

    // 扩展fillFormData函数，处理病害选择字段的数据回显
    var originalFillFormData = fillFormData;
    fillFormData = function(dataList) {
        // 调用原始函数
        originalFillFormData(dataList);

        // 处理病害选择字段的显示更新
        setTimeout(function() {
            // 检查是否有病害选择相关的数据
            var focusDiseasesValue = $('input[data-original-key="${chapter-7-1-focusOnDiseases}"]').val();
            var causeAnalysisValue = $('input[data-original-key="${chapter-7-2-analysisOfTheCausesOfMajorDiseases}"]').val();

            console.log('数据回显检查 - 重点关注病害字段:', $('input[data-original-key="${chapter-7-1-focusOnDiseases}"]').length);
            console.log('数据回显检查 - 重点关注病害值:', focusDiseasesValue);
            console.log('数据回显检查 - 成因分析字段:', $('input[data-original-key="${chapter-7-2-analysisOfTheCausesOfMajorDiseases}"]').length);
            console.log('数据回显检查 - 成因分析值:', causeAnalysisValue);

            // 直接更新显示（不需要预加载diseaseComponentData，因为显示不再需要具体的名称映射）
            if (focusDiseasesValue) {
                updateDiseaseDisplay('focus-diseases');
            } else {
                // 如果没有数据，确保显示"请选择"
                $('#focus-diseases-display').val('请选择');
            }

            if (causeAnalysisValue) {
                updateDiseaseDisplay('cause-analysis');
            } else {
                // 如果没有数据，确保显示"请选择"
                $('#cause-analysis-display').val('请选择');
            }
        }, 100);
    };
</script>
</body>
</html> 